<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=780">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>Однорукий бандит</title>

    <link rel="stylesheet" href="stylesheets/style.css"/>
  </head>
  <body>
    <div class="page__header">
      <div class="content__inner">
        200 лет Арзамасу
      </div>
    </div>
    <div style="width: 950px; margin: 0 auto;">
      <div class="wrapper__slot-machine">
        <div class="slot-machine__block">
          <div class="machine__handle handle__ready"></div>
          <div class="machine__image_head"></div>
          <div class="machine__label">
            Русская тройка
          </div>
          <div class="machine__lights"></div>

          <div class="slots__container">
            <ul></ul>
          </div>

          <div class="machine__paper-share">
            <div class="share__title">Это успех!</div>
            <div class="share__block">
              <div class="sub__title">Поделиться:</div>
              <div class="socials__list">
                <div class="social__item social__item_fb">
                  <a class="share-button" data-track-social="facebook" href="#" title="Поделиться в Facebook">
                    <img src="//cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/images/social_icons/ico_fb.png"
                         alt=""/>
                  </a>
                </div>
                <div class="social__item social__item_vk">
                  <a class="share-button" data-track-social="vk" href="#" title="Поделиться в VK">
                    <img src="//cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/images/social_icons/ico_vk.png"
                         alt=""/>
                  </a>
                </div>
                <div class="social__item social__item_tw">
                  <a class="share-button" data-track-social="twitter" href="#" title="Поделиться в Twitter">
                    <img src="//cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/images/social_icons/ico_tw.png"
                         alt=""/>
                  </a>
                </div>
                <div class="social__item social__item_ok">
                  <a class="share-button" data-track-social="ok" href="#" title="Поделиться в Одноклассниках">
                    <img src="//cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/images/social_icons/ico_ok.png"
                         alt=""/>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p style="width: 660px; margin: 0 auto; font-size: 18px; line-height: 25px;">
        Работа под названием «Захоронение Нефертити?» опубликована на научном сайте academia.edu.
        Николас Ривз, египтолог Института Аризоны, изучил фотографии и 3D-сканы гробницы,
        сделанные в начале года компанией Factum Ave, и, как он считает, увидел следы двух дверей, ведущих в
        скрытые помещения, одно из которых, возможно, является сокровищницей, а другое — местом захоронения
        царицы (на что якобы указывают и фрески на стене).
      </p>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/javascripts/jSlots.js"></script>
    <script src="http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/javascripts/howler.min.js"></script>

    <script type="text/javascript">
      $(function () {

        var slotMachine = {
          isLaunched: false,

          phraseCombinations: {
            0: [
              'православие',
              'секс',
              'свобода',
              'карты',
              'камень',
              'чемодан',
              'тройка',
              'Ленин',
              'мир',
              'детство',
              'украл',
              'чай',
              'тополиный пух',
              'огонь',
              'первое',
              'лебедь',
              'бульбазавр',
              'вера',
              'кино',
              'мир',
              'послесловие ',
              'перестройка '
            ],
            1: [
              'самодержавие',
              'наркотики',
              'равенство',
              'деньги',
              'ножницы',
              'вокзал',
              'семерка',
              'партия',
              'труд',
              'отрочество',
              'выпил',
              'кофе',
              'жара',
              'вода',
              'второе',
              'рак',
              'чармандер',
              'надежда',
              'вино',
              'дружба',
              'самовозгорание',
              'ускорение'
            ],
            2: [
              'народность',
              'рок-н-ролл',
              'братство',
              'два ствола',
              'бумага',
              'израиль',
              'туз',
              'комсомол',
              'май',
              'юность',
              'в тюрьму',
              'потанцуем',
              'июль',
              'медные трубы',
              'компот',
              'щука',
              'сквиртл',
              'любовь',
              'домино',
              'жвачка',
              'нарядность',
              'гласность'
            ]
          },

          sharePhraseCombinations: [
            'народности',
            'рок-н-ролльности',
            'братности',
            'двуствольности',
            'бумажности',
            'израильности',
            'тузности',
            'комсомольности',
            'майности',
            'юности',
            'втюрьмуйности',
            'потанцуемости',
            'июльности',
            'меднотрубности',
            'компотности',
            'щучности',
            'сквиртлности',
            'любви',
            'доминошности',
            'жвачности',
            'нарядности',
            'гласности'
          ],

          launchCount: 0,

          handleInterval: null,
          lightsInterval: null,

          slotSound: null,
          handleSound: null,
          gooseSound: null,
          lightSound: null,
          printSound: null,
          normalWinSound: null,
          victorySound: null,

          init: function () {
            var that = this;

            $('.slot-machine__block .machine__handle').addClass('handle__ready');

            $('.slots__container ul').jSlots({
              spinner: '.slot-machine__block .machine__handle.handle__ready',
              delay: 500,
              spinStopDelay: 2400,
              time: 3000,
              loops: 4,
              slotItems: that.phraseCombinations,
              correctAttempt: 10,
              onStart: function () {
                $('.slot-machine__block .machine__handle').removeClass('handle__ready');
              },
              beforeEnd: function () {
                that.slotSound.play();
              },
              onEnd: function (finalNumbers) {
                clearInterval(that.lightsInterval);
                $('.slot-machine__block .machine__image_head').removeClass('machine__image_head_active');
                $('.slot-machine__block .machine__lights')[0].className = 'machine__lights';

                that.lightSound.stop();

                that.prepareShare(finalNumbers);
                that.showShare(finalNumbers);
              }
            });

            that.prepareSounds();
          },
          prepareSounds: function () {
            this.slotSound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-slot1.mp3']
            });

            this.handleSound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-handle.mp3']
            });

            this.gooseSound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-goose.mp3']
            });

            this.lightSound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-music.mp3']
            });

            this.printSound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-print.mp3']
            });

            this.victorySound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-victorymusic.mp3']
            });

            this.normalWinSound = new Howl({
              urls: ['http://cdn-s-static.arzamas.academy/x/132-arzamas-200-jftuKKdjfjth3/875/sounds/az-slots-normalwin.mp3']
            });
          },
          launch: function () {
            if (!this.isLaunched) {
              this.toggleHandle();
              this.toggleGoose();
              this.toggleLights();
            }
          },
          toggleHandle: function () {
            var handleState = 0,
              direction = 'down',
              that = this;

            that.isLaunched = true;

            that.handleSound.play();

            if (that.launchCount > 0) {
              $('.slot-machine__block .machine__paper-share').addClass('machine__paper-rotateFall');
              setTimeout(function () {
                $('.slot-machine__block .machine__paper-share').hide().removeClass('machine__paper-rotateFall');
                setTimeout(function () {
                  $('.slot-machine__block .machine__paper-share').show().removeAttr('style');
                }, 1000);
              }, 1000);
            }

            that.handleInterval = setInterval(function () {

              if (direction == 'down' && handleState >= 0 && handleState < 4) {
                handleState++;
                if (handleState == 4) {
                  direction = 'up';
                }
              } else if (direction == 'up' && handleState > 0) {
                handleState--;
              }

              $('.slot-machine__block .machine__handle')[0].className = 'machine__handle machine__handle_' + handleState;

              if (handleState == 0) {
                $('.slot-machine__block .machine__handle').removeClass('machine__handle_0');
                clearInterval(that.handleInterval);
              }
            }, 100);
          },
          toggleGoose: function () {
            var that = this;

            that.gooseSound.play();
            $('.slot-machine__block .machine__image_head').addClass('machine__image_head_active');
            setTimeout(function () {
              that.gooseSound.stop();
              $('.slot-machine__block .machine__image_head').removeClass('machine__image_head_active');
            }, 1000);
          },
          toggleLights: function () {
            var lightState = 0,
              that = this;

            setTimeout(function () {
              that.lightSound.play();

              that.lightsInterval = setInterval(function () {
                if (lightState >= 3) {
                  lightState = 0;
                }
                lightState++;

                $('.slot-machine__block .machine__lights')[0].className = 'machine__lights machine__lights_' + lightState;
              }, 500);
            }, 500);
          },

          prepareShare: function (finalNumbers) {
            var theoryTitleString = 'Вот моя Теория официальной ' + this.sharePhraseCombinations[finalNumbers[2] - 1];

            var imagePart1 = finalNumbers[0] - 1,
              imagePart2 = finalNumbers[1] - 1,
              imagePart3 = finalNumbers[2] - 1;
            console.log(imagePart1, imagePart2, imagePart3);
            if (imagePart1 > 10) {
              imagePart1 += 1;
            }
            if (imagePart2 > 10) {
              imagePart2 += 1;
            }
            if (imagePart3 > 10) {
              imagePart3 += 1;
            }
            var picUrl = encodeURIComponent('875/' + imagePart1.toString() + '/' + imagePart2.toString() + '/' + imagePart3.toString() + '.png'); // Для картинки http://cdn-s-static.arzamas.academy/results/875/0/0/0.jpg, префикс автоматически прибавится на сервере
            var shareText = encodeURIComponent(theoryTitleString);

            var shareUrl = encodeURIComponent('http://arzamas.academy/results/875?pic=' + picUrl + '&text=' + shareText);
            var twitterShareUrl = encodeURIComponent('http://arzamas.academy/results/875?pic=' + picUrl);

            $('.social__item_vk .share-button', '.machine__paper-share').attr('href', 'https://vk.com/share.php?url=' + shareUrl);
            $('.social__item_fb .share-button', '.machine__paper-share').attr('href', 'https://www.facebook.com/sharer/sharer.php?u=' + shareUrl);
            $('.social__item_ok .share-button', '.machine__paper-share').attr('href', 'http://connect.ok.ru/dk?st.cmd=WidgetSharePreview&st.shareUrl=' + shareUrl);
            $('.social__item_tw .share-button', '.machine__paper-share').attr('href', 'https://twitter.com/intent/tweet?text=' + shareText + '&original_referer=' + twitterShareUrl + '&url=' + twitterShareUrl);

            $('.share__title', '.machine__paper-share').html(theoryTitleString);

            $('.wrapper__slot-machine .machine__paper-share').show();

            var that = this;
            $('.machine__paper-share .share-button').off('click').click(function (e) {
              e.preventDefault();
              var $this, href, title;
              $this = $(this);
              href = $this.attr('href');
              title = $this.attr('title');
              that.prepareSharePopup(href, title, 500, 600);
            });
          },

          prepareSharePopup: function (url, title, w, h) {
            var left, top;
            left = screen.width / 2 - (w / 2);
            top = screen.height / 2 - (h / 2);
            return window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);
          },

          showShare: function (finalNumbers) {
            var that = this;

            setTimeout(function () {
              if (finalNumbers[0] == finalNumbers[1] && finalNumbers[0] == finalNumbers[2]) {
                that.victorySound.play();
              } else {
                that.normalWinSound.play();
              }

              setTimeout(function () {
                that.printSound.play();

                var paperOffsetBottom = 179 - $('.slot-machine__block .machine__paper-share').outerHeight();

                $('.slot-machine__block .machine__paper-share').animate({
                  bottom: paperOffsetBottom
                }, {
                  duration: 800,
                  complete: function () {
                    that.isLaunched = false;
                    $('.slot-machine__block .machine__handle').addClass('handle__ready');
                  }
                });
              }, 1000);
            }, 500);

            this.launchCount++;
          }
        };

        slotMachine.init();

        $('.slot-machine__block .machine__handle').click(function () {
          slotMachine.launch();
        });

        $('.slot-machine__block .machine__image_head').hover(function () {
          slotMachine.gooseSound.play();
        }, function () {
          slotMachine.gooseSound.stop();
        });
      });
    </script>
  </body>
</html>